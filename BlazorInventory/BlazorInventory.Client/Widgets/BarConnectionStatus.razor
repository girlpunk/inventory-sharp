@using ActualLab.Fusion.Extensions
@using ActualLab.Rpc
@using ActualLab.Time
@inherits StatefulComponentBase<RpcPeerState>

@{
    var m = State.Value;
    var isOk = m.Kind is not RpcPeerStateKind.Disconnected;
    var iconName = isOk
        ? "cloud"
        : "warning";
    var textColor = isOk
        ? "Default"
        : "Warning";
}

<div class="@CssClass">
    <Icon type="@iconName" Style="@($"color: ${textColor};")" />
    <div Style="@($"color: ${textColor}")">
        <span>@m.GetDescription(true)</span>
        @if (m.ReconnectsIn != default) {
            <span> Will reconnect <TimerBadge ExpiresAt="@(Clock.Now + m.ReconnectsIn)"/>. </span>
            <Button Color="Color.Green1" @onclick="Reconnect">Reconnect</Button>
        }
    </div>
</div>

@code {
    // [Inject] private RpcPeerStateMonitor Monitor { get; init; } = null!;
    [Inject] private MomentClock Clock { get; init; } = null!;

    [Parameter] public string CssClass { get; set; } = "";

    // protected override void OnInitialized()
        // => SetState(Monitor.State);

    public override ValueTask DisposeAsync()
        => default; // State shouldn't be disposed

    private void Reconnect()
        => Services.RpcHub().InternalServices.ClientPeerReconnectDelayer.CancelDelays();
}